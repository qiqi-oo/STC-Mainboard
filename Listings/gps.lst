C51 COMPILER V9.60.0.0   GPS                                                               09/20/2025 15:17:36 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE GPS
OBJECT MODULE PLACED IN .\Objects\gps.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE App\gps.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\List
                    -ings\gps.lst) TABS(2) OBJECT(.\Objects\gps.obj)

line level    source

   1          /*#include <stdio.h>
   2          #include <string.h>
   3          #include  "./User/config.h"
   4          #include  "./User/includes.h"
   5          
   6          
   7          
   8          
   9          #ifdef  STC15W4K48S4
  10          
  11          xdata u8 GpsRxBuffer[128]=""; //æ¥æ”¶ç¼“å†²
  12          
  13          u8 code CMD_GpsConfFail[] = {0x53,0x5A,0x43,0x47};//Gpsé…ç½®å¤±è´¥æŒ‡ä»¤
  14          u8 code CMD_GpsConfSucc[] = {0x44,0x51,0x43,0x47,0x00};//Gpsé…ç½®æˆåŠŸæŒ‡ä»¤
  15          
  16          
  17          char code  CMD_GpsAckSucc[] = "OK";//Gpsé…ç½®æˆåŠŸæŒ‡ä»¤
  18          
  19          char code  CMD_BY_BaseAuto[] =  "fix auto\r\n";//è‡ªåŠ¨è·å–åŸºå‡†ç«™åæ ‡
  20          char code  CMD_BY_GetBasePos[] =  "log refstationa\r\n";//è·å–åŸºå‡†ç«™åæ ‡
  21          
  22          char code  CMD_HX_BaseAuto[] =  "fix auto\r\n";//è‡ªåŠ¨è·å–åŸºå‡†ç«™åæ ‡
  23          char code  CMD_HX_GetBasePos[] =  "log bestposa\r\n";//è·å–åŸºå‡†ç«™åæ ‡
  24          
  25          
  26          char code  CMD_ConfigEnd[] = "Configuration complete\r\n";//é…ç½®ç»“æŸæŒ‡ä»¤ï¼Œç”¨äºç¨‹åºçš„å¾ªç¯æ˜¯å
             -¦ç»“æŸï¼Œä¸GPSé…ç½®æ— å…³ï¼Œå¿…é¡»æœ‰ï¼ï¼
  27          char code  CMD_BY_BaseStation[][CMD_GPS_LENTH] =         //åŒ—äº‘GPSåŸºå‡†ç«™æŒ‡ä»¤
  28          {
  29            "interfacemode com3 bynav bynav\r\n",//ï¼ˆé…ç½®ç«¯å£çš„è¾“å…¥ç±»å‹ä¸ºbynavï¼‰
  30            "interfacemode com2 rtcm rtcm\r\n",//ï¼ˆé…ç½®ç«¯å£è¾“å‡ºç±»å‹ä¸ºrtcmï¼‰
  31            "rtktype base\r\n",// //è®¾ç½®ä¸ºåŸºå‡†ç«™
  32            "fix auto\r\n",////è‡ªåŠ¨è·å–åŸºå‡†ç«™åæ ‡
  33            "serialconfig com1 38400\r\n",//
  34            "serialconfig com2 38400\r\n",//
  35            "serialconfig com3 38400\r\n",//
  36            "log com2 rtcm1074 ontime 1\r\n",//
  37            "log com2 rtcm1084 ontime 1\r\n",//
  38            "log com2 rtcm1114 ontime 1\r\n",//
  39            "log com2 rtcm1124 ontime 1\r\n",//
  40            "log com2 rtcm1006 ontime 5\r\n",//
  41            "log com2 rtcm1033 ontime 10\r\n",//
  42            "unlogall com3\r\n",//
  43            "log com3 gpgga ontime 1\r\n",//
  44            "saveconfig\r\n",             //
  45            "reboot\r\n",                 // //é‡å¯   
  46            "Configuration complete\r\n"  //é…ç½®ç»“æŸæŒ‡ä»¤ï¼Œç”¨äºç¨‹åºçš„å¾ªç¯æ˜¯å¦ç»“æŸï¼Œä¸GPSé…ç½®æ— å…
             -³ï¼Œå¿…é¡»æœ‰ï¼ï¼ 
  47          };
  48          
  49          char code  CMD_BY_MobileStation[][CMD_GPS_LENTH] =         //åŒ—äº‘GPSç§»åŠ¨ç«™é…ç½®æŒ‡ä»¤
  50          {
  51            "interfacemode com3 bynav bynav\r\n",//
  52            "unlogall\r\n",
C51 COMPILER V9.60.0.0   GPS                                                               09/20/2025 15:17:36 PAGE 2   

  53            "interfacemode com2 rtcm rtcm\r\n",
  54            "rtktypertk rover\r\n",
  55            "interfacemode com3 bynav bynav\r\n",
  56            "serialconfig com2 38400\r\n",
  57            "serialconfig com3 38400\r\n",
  58            "serialconfig com1 38400\r\n",
  59            "log com3 ptnlpjk ontime 0.1\r\n",
  60            "log com3 gpvtg ontime 0.1\r\n",
  61            "log com3 ptnlavr ontime 0.1\r\n",
  62            "saveconfig\r\n",   
  63            "Configuration complete\r\n", //é…ç½®ç»“æŸæŒ‡ä»¤ï¼Œç”¨äºç¨‹åºçš„å¾ªç¯æ˜¯å¦ç»“æŸï¼Œä¸GPSé…ç½®æ— å
             -…³ï¼Œå¿…é¡»æœ‰ï¼ï¼
  64          };
  65          
  66          char code  CMD_HX_BaseStation[][CMD_GPS_LENTH] =         //åˆèŠ¯GPSåŸºå‡†ç«™æŒ‡ä»¤
  67          {
  68            "lmode base time 60 1.5 2.5\r\n",       //å°†GPSè®¾ç½®ä¸ºåŸºå‡†ç«™
  69            "fix auto\r\n",                     //è‡ªåŠ¨è·å–åŸºå‡†ç«™åæ ‡
  70            "unlog com3\r\n",               
  71            "log com2 rtcm1033 ontime 10\r\n",                  
  72            "log com2 rtcm1006 ontime 10\r\n",//
  73            "log com2 rtcm1074 ontime 1\r\n",//
  74            "log com2 rtcm1084 ontime 1\r\n",//
  75            "log com2 rtcm1124 ontime 1\r\n",//
  76            "log com2 rtcm1094 ontime 1\r\n",//
  77            "config com2 38400\r\n",//
  78            "config com3 38400\r\n",//
  79            "saveconfig\r\n",//   
  80            "Configuration complete\r\n"  //é…ç½®ç»“æŸæŒ‡ä»¤ï¼Œç”¨äºç¨‹åºçš„å¾ªç¯æ˜¯å¦ç»“æŸï¼Œä¸GPSé…ç½®æ— å…
             -³ï¼Œå¿…é¡»æœ‰ï¼ï¼
  81          };
  82          
  83          
  84          char code  CMD_HX10Hz_MobileStation[][CMD_GPS_LENTH] =         //åˆèŠ¯GPSç§»åŠ¨ç«™æŒ‡ä»¤
  85          {
  86            "log headinga ontime 1\r\n",        //å°†GPSè®¾ç½®ä¸ºåŸºå‡†ç«™
  87            "com com2 38400\r\n",                     //è‡ªåŠ¨è·å–åŸºå‡†ç«™åæ ‡
  88            "com com3 38400\r\n",               
  89            "Unlogall com2\r\n",                  
  90            "Unlogall com3\r\n",//
  91            "log com3 gpntr ontime 0.1\r\n",//
  92            "log com3 gptra onchanged\r\n",//
  93            "log com3 gpvtg ontime 0.1\r\n",//
  94            "log com3 gprmc ontime 0.1\r\n",//
  95            "Headingmode variablelength \r\n",//
  96            "mode rover\r\n",//
  97            "saveconfig\r\n",//   
  98            "Configuration complete\r\n"  //é…ç½®ç»“æŸæŒ‡ä»¤ï¼Œç”¨äºç¨‹åºçš„å¾ªç¯æ˜¯å¦ç»“æŸï¼Œä¸GPSé…ç½®æ— å…
             -³ï¼Œå¿…é¡»æœ‰ï¼ï¼ 
  99          };
 100          
 101          char code  CMD_HX5Hz_MobileStation[][CMD_GPS_LENTH] =         //åˆèŠ¯GPSç§»åŠ¨ç«™æŒ‡ä»¤
 102          {
 103            "log headinga ontime 1\r\n",        //å°†GPSè®¾ç½®ä¸ºåŸºå‡†ç«™
 104            "com com2 38400\r\n",                     //è‡ªåŠ¨è·å–åŸºå‡†ç«™åæ ‡
 105            "com com3 38400\r\n",               
 106            "Unlogall com2\r\n",                  
 107            "Unlogall com3\r\n",//
 108            "log com3 gpntr ontime 0.2\r\n",//
 109            "log com3 gptra onchanged\r\n",//
 110            "log com3 gpvtg ontime 0.2\r\n",//
 111            "log com3 gprmc ontime 0.2\r\n",//
C51 COMPILER V9.60.0.0   GPS                                                               09/20/2025 15:17:36 PAGE 3   

 112            "Headingmode variablelength \r\n",//
 113            "mode rover\r\n",//
 114            "saveconfig\r\n",//   
 115            "Configuration complete\r\n"  //é…ç½®ç»“æŸæŒ‡ä»¤ï¼Œç”¨äºç¨‹åºçš„å¾ªç¯æ˜¯å¦ç»“æŸï¼Œä¸GPSé…ç½®æ— å…
             -³ï¼Œå¿…é¡»æœ‰ï¼ï¼ 
 116          };
 117          //========================================================================
 118          // å‡½æ•°: u8 GPS_Configuration(u8 USARTx,char *dat)
 119          // æè¿°: é…ç½®gpsï¼Œç»™gpså‘é€æŒ‡ä»¤ï¼ŒåŒæ—¶å¯æ ¹æ®æŒ‡ä»¤è¿”å›å·®åˆ†ç«™åæ ‡
 120           //      è¿ç»­å°è¯•3æ¬¡ï¼Œä¸æˆåŠŸå³é…ç½®å¤±è´¥
 121          // å‚æ•°ï¼šu8 USARTx,é…ç½®ä¸²å£ï¼Œchar *cmd æŒ‡å‘æŒ‡ä»¤çš„åœ°å€
 122          // è¿”å›: æ— 
 123          // ç‰ˆæœ¬: V1.0, 2022-10-17
 124          //========================================================================
 125          static u8 Configuration(u8 USARTx,char *cmd)  //é…ç½®GPSæ¿å¡
 126          {
 127            xdata u8 i=0;
 128            xdata u8 times=3;
 129            
 130            //printf("GPS_Configuration\r\n");
 131            
 132            while (times--)
 133            {
 134              
 135              if (strcmp(cmd,CMD_HX_BaseAuto) == 0)  //fix auto\r\nä¸åŒ—äº‘é€šç”¨
 136              {
 137                delay_ms(3000); //å»¶æ—¶3ç§’åï¼Œè·å–å·®åˆ†ç«™çš„å®šä½åæ ‡
 138              }
 139              
 140              BSP_ClearUsartRxBuffer(USARTx);//æ¸…ä¸²å£ç¼“å­˜
 141              
 142              USART_Sendbuffer(USARTx,cmd,strlen(cmd));//å‘é€é…ç½®æŒ‡ä»¤
 143              
 144              delay_ms(300);//å»¶æ—¶350è¯»å–æ¿å¡å›å¤
 145              
 146              memset(GpsRxBuffer, 0, sizeof(GpsRxBuffer));//æ¸…ç¼“å­˜æ•°æ®
 147              
 148              BSP_GetUsartRxBuffer(USARTx,GpsRxBuffer,sizeof(GpsRxBuffer));//è¯»å–ä¸²å£æ•°æ®
 149                    
 150              if(strstr((char *)GpsRxBuffer,CMD_GpsAckSucc) != NULL)  //Gpsé…ç½®æˆåŠŸæŒ‡ä»¤åº”ç­”æˆåŠŸOK
 151              {
 152                if (strstr(cmd,"com3 38400") != NULL) //æ”¹å˜ä¸²å£æ³¢ç‰¹ç‡æŒ‡ä»¤serialconfig com3 38400\r\n
 153                {
 154                  BSP_Usart_Init(USARTx,38400); //æ³¢ç‰¹ç‡å’ŒGPSä¸²å£æ³¢ç‰¹ç‡åŒæ­¥
 155                  S1_USE_P16P17();//STCåˆ‡æ¢ä¸²å£1åˆ°GPSä¸²å£
 156                }
 157                return(1);//æ”¶åˆ°GPSæ­£ç¡®çš„å›å¤
 158              }
 159            }
 160            return(0);//æœªæ”¶åˆ°GPSæ­£ç¡®çš„å›å¤
 161          }
 162          //========================================================================
 163          // å‡½æ•°: void GPS_EnterConfig(u8 USARTx, char **pcmd) //é…ç½®GPS
 164          // æè¿°: æŒ‰ç…§æŒ‡ä»¤é›†åˆpcmdçš„æŒ‡ä»¤é…ç½®GPSç§»åŠ¨ç«™ï¼ŒæŒ‡ä»¤é›†åˆä¸­æœ€åä¸€æ¡æŒ‡ä»¤å¿…é¡»æ˜¯C
             -MD_ConfigEnd
 165          // å‚æ•°ï¼šu8 USARTx,é…ç½®ä¸²å£,char (*pcmd)[CMD_GPS_LENTH]æŒ‡å‘æŒ‡ä»¤é›†åˆçš„æŒ‡é’ˆ
 166          // è¿”å›: æ— 
 167          // ç‰ˆæœ¬: V1.0, 2022-10-17
 168          //========================================================================
 169          static void EnterConfig(u8 USARTx, char (*pcmd)[CMD_GPS_LENTH]) 
 170          {
 171            xdata u8 Index = 0;//æŒ‡ä»¤åºå·
C51 COMPILER V9.60.0.0   GPS                                                               09/20/2025 15:17:36 PAGE 4   

 172            xdata u8 temp = 0;//
 173              
 174            S1_Int_on();//å¼€ä¸²å£1ä¸­æ–­
 175            
 176            BSP_Usart_Init(USARTx,115200);//æµ‹è¯•æ³¢ç‰¹ç‡
 177            S1_USE_P16P17();//STCåˆ‡æ¢ä¸²å£1åˆ°GPSä¸²å£
 178            
 179            if(Configuration(USARTx,pcmd[Index]) == 0)//é…ç½®å¤±è´¥
 180            {
 181               BSP_Usart_Init(USARTx,38400);//æµ‹è¯•æ³¢ç‰¹ç‡
 182               S1_USE_P16P17();//STCåˆ‡æ¢ä¸²å£1åˆ°GPSä¸²å£
 183            }
 184            if(Configuration(USARTx,pcmd[Index]) == 0)//é…ç½®å¤±è´¥
 185            {
 186               BSP_Usart_Init(USARTx,19200);//æµ‹è¯•æ³¢ç‰¹ç‡
 187                S1_USE_P16P17();//STCåˆ‡æ¢ä¸²å£1åˆ°GPSä¸²å£
 188            }
 189            if(Configuration(USARTx,pcmd[Index]) == 1)//æ³¢ç‰¹ç‡é€‚é…æˆåŠŸ 
 190            {
 191              while(strstr(pcmd[Index],CMD_ConfigEnd) == NULL)//æŸ¥è¯¢åˆ°é…ç½®å®ŒæˆæŒ‡ä»¤ï¼Œè·³å‡ºå¾ªç¯ï¼Œé…ç½®ç»“
             -æŸ
 192              {
 193                
 194                //printf("Index = %b02d\r\n",Index);
 195                
 196                temp = Configuration(USARTx,pcmd[Index]);//å‘é€é…ç½®æŒ‡ä»¤
 197                  
 198                if (temp == 0)//é…ç½®å¤±è´¥
 199                {
 200                  USART_Sendbuffer(UPLOAD_USART,CMD_GpsConfFail,sizeof(CMD_GpsConfFail));//å‘é€é…ç½®å¤±è´¥æŒ‡ä»¤
 201                  
 202                  USART_SendData(UPLOAD_USART,Index);//å‘é€é”™æŒ‡ä»¤ç´¢å¼•
 203                  
 204                  //printf("GpsConfFail :Index = %b02d\r\n",Index);
 205                  
 206                  return;//é…ç½®å¤±è´¥
 207                }
 208                
 209                Index ++;//ç§»åˆ°ä¸‹ä¸€ä¸ªæŒ‡ä»¤
 210                      
 211              }
 212            }
 213            USART_Sendbuffer(USARTx,CMD_GpsConfSucc,sizeof(CMD_GpsConfSucc));//åº”ç­”é…ç½®æˆåŠŸ
 214            
 215            //printf("GpsConfSucc\r\n",Index);      
 216          } 
 217          //========================================================================
 218          // å‡½æ•°: void GetBaseStationPos(void) 
 219          // æè¿°: å¾—åˆ°GPSåŸºå‡†ç«™åæ ‡ï¼Œä¸Šä¼ ç»™ä¸Šä½æœº
 220          // å‚æ•°ï¼šæ— 
 221          // è¿”å›: æ— 
 222          // ç‰ˆæœ¬: V1.0, 2022-10-17
 223          //========================================================================
 224          void GetBaseStationPos(void)  
 225          {
 226            xdata u8 i = 0 ;  //
 227            xdata u8 type = 0 ;//è·å–é…ç½®æ–‡ä»¶ï¼Œå¾—åˆ°gpsç±»å‹
 228            BSP_ClearUsartRxBuffer(GPS_USART);//æ¸…ä¸²å£ç¼“å­˜
 229            switch(type)
 230            {
 231              case BY_BASESTATION:
 232                        USART_Sendbuffer(GPS_USART,CMD_BY_GetBasePos,strlen(CMD_BY_GetBasePos));//å‘é€è·å–åŒ—äº‘gpsåŸºå
C51 COMPILER V9.60.0.0   GPS                                                               09/20/2025 15:17:36 PAGE 5   

             -‡†ç«™åæ ‡çš„æŒ‡ä»¤  
 233              case HX_BASESTATION:
 234                        USART_Sendbuffer(GPS_USART,CMD_BY_GetBasePos,strlen(CMD_BY_GetBasePos));//å‘é€è·å–åˆèŠ¯gpsåŸºå
             -‡†ç«™åæ ‡çš„æŒ‡ä»¤      
 235              default:
 236                      break;
 237                              
 238            } 
 239            delay_ms(300);
 240            
 241            memset(GpsRxBuffer, 0, sizeof(GpsRxBuffer));//æ¸…ç¼“å­˜æ•°æ®
 242              
 243            BSP_GetUsartRxBuffer(GPS_USART,GpsRxBuffer,sizeof(GpsRxBuffer));//è¯»å–ä¸²å£æ•°æ®
 244              
 245            for(i=0;i<strlen((char *)GpsRxBuffer);i++)
 246            {   
 247              USART_SendData(UPLOAD_USART,GpsRxBuffer[i]);//å›å¤åŸºå‡†ç«™åæ ‡
 248            }  
 249            BSP_ClearUsartRxBuffer(GPS_USART);//æ¸…ä¸²å£ç¼“å­˜                     
 250          }
 251          
 252          
 253          
 254          //========================================================================
 255          // å‡½æ•°: void GPS_EnterConfiguration(void)  
 256          // æè¿°: è¿›å…¥GPSé…ç½®æ¨¡å¼
 257          // å‚æ•°ï¼šmodeæ˜¯æŒ‡å®šå·®åˆ†ç«™è¿˜æ˜¯ç§»åŠ¨ç«™ï¼Œç”±ä¸Šä½æœºå†³å®š
 258          // è¿”å›: æ— 
 259          // ç‰ˆæœ¬: V1.0, 2022-10-17
 260          //========================================================================
 261          void GPS_EnterConfiguration(u8 mode)  
 262          {
 263            
 264            if  (mode ==BASESTATION )
 265            {
 266                switch(GNSS_MODEL)
 267                {
 268                  case BY_BASESTATION:
 269                                      EnterConfig(GPS_USART,CMD_BY_BaseStation);//è¿›å…¥åŒ—äº‘GPSåŸºå‡†ç«™é…ç½®
 270                                      break;
 271                  case HX_BASESTATION:
 272                                      EnterConfig(GPS_USART,CMD_HX_BaseStation);//è¿›å…¥åˆèŠ¯GPSåŸºå‡†ç«™é…ç½®
 273                                      break;    
 274                  default:
 275                          break;
 276                }
 277                              
 278            } 
 279            if  (mode == MOBILESTATION)
 280            {
 281                switch(GNSS_MODEL)
 282                {
 283                  case BY_MOBILESTATION:
 284                                      EnterConfig(GPS_USART,CMD_BY_MobileStation);      //è¿›å…¥åŒ—äº‘GPSç§»åŠ¨ç«™é…ç½®
 285                                      break;
 286                  case HX10HZ_MOBILESTATION:
 287                                      EnterConfig(GPS_USART,CMD_HX10Hz_MobileStation);  //è¿›å…¥åˆèŠ¯10HzGPSç§»åŠ¨ç«™é…ç½®
 288                                      break;    
 289                  case HX5HZ_MOBILESTATION:
 290                                      EnterConfig(GPS_USART,CMD_HX5Hz_MobileStation);   //è¿›å…¥åˆèŠ¯5HzGPSç§»åŠ¨ç«™é…ç½®
 291                                      break;  
 292                  default:
C51 COMPILER V9.60.0.0   GPS                                                               09/20/2025 15:17:36 PAGE 6   

 293                          break;
 294                }   
 295            }
 296              
 297                            
 298          }
 299          #endif
 300          */


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   ----    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
